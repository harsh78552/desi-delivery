<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <link rel="icon" type="image/png/jpg" href="../image/myImage.jpg">
    <title>Menu</title>

    <script>
        const token = localStorage.getItem("userToken");

        function redirectToLogin() {
            localStorage.removeItem("userToken");
            window.location.href = "user_login.html";
        }

        // ðŸ”’ Token validation
        if (token) {
            try {
                const parts = token.split(".");
                if (parts.length !== 3) throw new Error("Invalid token format");

                const payload = JSON.parse(atob(parts[1]));
                const expiry = payload.exp;
                const role = payload.role;
                const now = Math.floor(Date.now() / 1000);

                if (now > expiry || role !== "user") redirectToLogin();
            } catch (err) {
                console.error("Token Error:", err);
                redirectToLogin();
            }
        } else redirectToLogin();
    </script>

    <style>
        body {
            font-family: Arial;
            margin: 0;
            background: #f2f2f2;
        }

        /* Navbar */
        .navbar {
            width: 100%;
            background: #131921;
            color: white;
            padding: 12px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .nav-left {
            font-size: 22px;
            font-weight: bold;
            letter-spacing: 1px;
        }

        .nav-categories {
            display: flex;
            gap: 20px;
            margin-left: 40px;
        }

        .nav-categories span {
            cursor: pointer;
            padding: 6px 10px;
            border-radius: 4px;
            transition: 0.2s;
        }

        .nav-categories span:hover {
            background: #232f3e;
        }

        .nav-right {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .nav-right button {
            padding: 6px 12px;
            font-size: 14px;
            border: none;
            cursor: pointer;
            border-radius: 4px;
        }

        .profile-btn { background: #ff9900; }
        .about-btn { background: #ffa31a; }
        .logout-btn { background: #e65c00; color: white; }

        /* Menu Cards */
        .category-box {
            background: white;
            padding: 15px;
            margin: 25px;
            border-radius: 10px;
            box-shadow: 0 2px 5px #ccc;
        }

        .food-card {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
            background: #fff;
            padding: 10px;
            border-radius: 8px;
            border: 1px solid #ddd;
            cursor: pointer;
            transition: 0.2s;
        }

        .food-card:hover {
            box-shadow: 0 4px 10px #bbb;
        }

        .food-card img {
            width: 120px;
            height: 90px;
            object-fit: cover;
            border-radius: 8px;
        }

        /* Toast */
        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #333;
            color: #fff;
            padding: 12px 20px;
            border-radius: 6px;
            opacity: 0.95;
            font-size: 14px;
            z-index: 1000;
            animation: fadeOut 3s forwards;
            box-shadow: 0 2px 6px rgba(0,0,0,0.3);
        }

        .toast.success { background: #28a745; }
        .toast.error { background: #dc3545; }
        .toast.info { background: #007bff; }

        @keyframes fadeOut {
            0% { opacity: 0.95; }
            80% { opacity: 0.95; }
            100% { opacity: 0; }
        }
    </style>
</head>

<body>

<div class="navbar">
    <div class="nav-left">Food Ordering</div>

    <div class="nav-categories" id="category-list"></div>

    <div class="nav-right">

        <div id="cart-area"
             style="cursor:pointer; display:flex; align-items:center; gap:6px;"
             onclick="openCartWithRefresh()">Cart
            <span id="cart-count"
                  style="background:#28a745; padding:4px 10px; border-radius:50%; font-size:14px;">
                0
            </span>
        </div>

        <button class="profile-btn" onclick="goProfile()">Profile</button>
        <button class="about-btn" onclick="goAbout()">About</button>
        <button class="logout-btn" onclick="logout()">Logout</button>
    </div>
</div>


<h2 style="padding-left: 25px;">Menu Items</h2>
<div id="menu-container" style="padding: 20px;">Loading...</div>

<script>
    /* ---------------- TOKEN CHECK ---------------- */
    if (token) {
        try {
            const parts = token.split(".");
            if (parts.length !== 3) throw new Error("Invalid token format");

            const payload = JSON.parse(atob(parts[1]));
            const expiry = payload.exp;
            const role = payload.role;
            const now = Math.floor(Date.now() / 1000);

            if (now > expiry || role !== "user") redirectToLogin();
        } catch (err) {
            console.error("Token Error:", err);
            redirectToLogin();
        }
    } else redirectToLogin();


    /* ---------------- CART COUNT ---------------- */
    async function loadCartCount() {
        try {
            const res = await fetch("https://desi-delivery.onrender.com/fetch-total-item-add-in-cart", {
                method: "GET",
                headers: { "Authorization": "Bearer " + token }
            });

            const data = await res.json();
            if (res.ok) {
                document.getElementById("cart-count").innerText = data.item_count || 0;
            }
        } catch (err) {
            console.log("Cart count load failed:", err);
        }
    }


    /* ---------------- FAST MENU USING CACHE ---------------- */
    function renderMenu(menuData) {
        const container = document.getElementById("menu-container");
        const navbarCategories = document.getElementById("category-list");

        container.innerHTML = "";
        navbarCategories.innerHTML = "";

        menuData.forEach(cat => {
            const catTab = document.createElement("span");
            catTab.innerText = cat.category;
            catTab.onclick = () => scrollToCategory(cat.category);
            navbarCategories.appendChild(catTab);

            const box = document.createElement("div");
            box.classList.add("category-box");
            box.id = cat.category.replace(/\s+/g, "-");

            const itemsHTML = cat.items.map(item => `
                <div class="food-card" onclick="viewFoodDetail('${cat.category}', '${item.food_name}')">
                    <img src="${item.image_url}">
                    <div>
                        <h4>${item.food_name}</h4>
                        <p>${item.descriptions}</p>
                        <b>Price: ${item.price}</b><br>
                        <small>Category: ${item.sub_category}</small>
                    </div>
                </div>
            `).join("");

            box.innerHTML = `<h3>${cat.category}</h3>${itemsHTML}`;
            container.appendChild(box);
        });
    }


    async function loadMenu() {
        const cachedMenu = localStorage.getItem("menuData");

        // 1ï¸âƒ£ Load cached menu instantly
        if (cachedMenu) {
            renderMenu(JSON.parse(cachedMenu));
        }

        // 2ï¸âƒ£ Fetch fresh menu quietly
        try {
            const res = await fetch("https://desi-delivery.onrender.com/menu", {
                method: "GET",
                headers: {
                    "Authorization": "Bearer " + token,
                    "Content-Type": "application/json"
                }
            });

            const menuData = await res.json();

            // Save new menu in storage
            localStorage.setItem("menuData", JSON.stringify(menuData));

            // Render fresh updated UI
            renderMenu(menuData);

        } catch (err) {
            console.error(err);
            showToast("Error loading menu.", "error");
        }
    }


    /* ---------------- NAVIGATION FUNCTIONS ---------------- */
    function scrollToCategory(catName) {
        const id = catName.replace(/\s+/g, "-");
        document.getElementById(id).scrollIntoView({ behavior: "smooth" });
    }

    function viewFoodDetail(category, foodName) {
        localStorage.setItem("selectedCategory", category);
        localStorage.setItem("selectedItemName", foodName);
        window.location.href = "item_detail.html";
    }

    function goProfile() { window.location.href = "user_profile.html"; }
    function goAbout() { window.location.href = "about_us.html"; }

    function logout() {
        localStorage.removeItem("userToken");
        showToast("Logged out successfully!", "success");
        setTimeout(() => window.location.href = "user_login.html", 1000);
    }


    /* ---------------- CART CLICK ---------------- */
    async function openCartWithRefresh() {
        try {
            const res = await fetch("https://desi-delivery.onrender.com//fetch-all-item-added-in-cart", {
                method: "GET",
                headers: { "Authorization": "Bearer " + token }
            });

            const data = await res.json();
            if (res.ok) {
                document.getElementById("cart-count").innerText = data.item_count || 0;
            }
        } catch (err) {
            console.log("Cart refresh failed:", err);
        }

        window.location.href = "all_add_to_cart_item.html";
    }


    /* ---------------- TOAST ---------------- */
    function showToast(message, type="info") {
        const toast = document.createElement("div");
        toast.className = `toast ${type}`;
        toast.innerText = message;
        document.body.appendChild(toast);
        setTimeout(() => toast.remove(), 3000);
    }


    /* ---------------- INITIAL LOAD ---------------- */
    loadCartCount();
    loadMenu();

    // Refresh cart count when user returns back from item_detail
    window.addEventListener("pageshow", () => {
        loadCartCount();
    });

</script>


</body>
</html>
