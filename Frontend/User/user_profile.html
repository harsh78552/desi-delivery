<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>User Profile - Vyanjanam</title>
    <meta name="description"
          content="View and edit your user profile on Vyanjanam. Keep your contact and address information updated.">
    <meta name="keywords" content="Vyanjanam, User Profile, Restaurant, Indian Cuisine, Edit Profile">
    <meta name="robots" content="index, follow">
    <link rel="icon" type="image/png/jpg" href="../image/myImage.jpg">


    <script type="application/ld+json" id="json-ld">
        {
            "@context": "https://schema.org",
            "@type": "Person",
            "name": "User Name",
            "url": "",
            "description": "User profile page for Vyanjanam website. Users can view and update their contact and address details.",
            "image": "../image/myImage.jpg"
        }
    </script>

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #fff; display: flex; justify-content: center; align-items: flex-start; padding: 50px; min-height: 100vh; color: #333; }
        .profile-container { width: 400px; padding: 25px; border-radius: 12px; display: none; animation: fadeIn 0.4s ease; box-shadow: 0 6px 20px rgba(0,0,0,0.1); }
        @keyframes fadeIn { from {opacity: 0;} to {opacity: 1;} }
        h2 { text-align: center; margin-bottom: 20px; font-weight: 700; font-size: 24px; color: #333; }
        .back-btn { display: inline-block; margin-bottom: 15px; padding: 8px 15px; border-radius: 20px; background-color: #6c757d; color: #fff; font-weight: 600; cursor: pointer; text-decoration: none; transition: background 0.2s, transform 0.1s; }
        .back-btn:hover { background-color: #5a6268; transform: translateY(-2px); }
        label { display: block; margin-top: 15px; font-weight: 600; font-size: 14px; }
        input, textarea { width: 100%; padding: 10px; margin-top: 6px; border: 1px solid #ccc; border-radius: 12px; font-size: 14px; background: #f9f9f9; color: #333; outline: none; transition: background 0.2s, border 0.2s; }
        input:focus, textarea:focus { background: #fff; border: 1px solid #007bff; }
        input[disabled], textarea[disabled] { background: #eee; cursor: not-allowed; color: #555; }
        .actions { margin-top: 20px; text-align: center; }
        button { padding: 10px 20px; border: none; border-radius: 25px; cursor: pointer; font-size: 15px; font-weight: bold; transition: transform 0.1s ease, box-shadow 0.2s ease; }
        button:hover { transform: translateY(-2px); box-shadow: 0 6px 15px rgba(0,0,0,0.2); }
        .edit-btn { background-color: #007bff; color: white; }
        .save-btn { background-color: #28a745; color: white; margin-left: 10px; display: none; }
        #messageBox { display: none; text-align: center; margin-bottom: 15px; padding: 10px; border-radius: 8px; font-weight: bold; }
        #loading { display: flex; justify-content: center; align-items: center; flex-direction: column; font-size: 16px; margin-top: 50px; color: #333; }
        .spinner { border: 4px solid rgba(0,0,0,0.1); border-top: 4px solid #333; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin-bottom: 10px; }
        @keyframes spin { 0% { transform: rotate(0deg);} 100% { transform: rotate(360deg);} }
    </style>
</head>
<body>

<div id="loading">
    <div class="spinner"></div>
    Loading profile...
</div>

<div class="profile-container" id="profileContainer">
    <a href="#" class="back-btn" onclick="goBack()"> Back</a>
    <h2>User Profile</h2>
    <div id="messageBox"></div>
    <form id="profileForm">
        <label for="name">Name</label>
        <input type="text" id="name" disabled placeholder="Loading...">

        <label for="email">Email</label>
        <input type="email" id="email" disabled placeholder="Loading...">

        <label for="contact">Contact</label>
        <input type="text" id="contact" disabled placeholder="Loading...">

        <label for="permanent">Permanent Address</label>
        <textarea id="permanent" rows="2" disabled placeholder="Loading..."></textarea>

        <label for="residential">Residential Address</label>
        <textarea id="residential" rows="2" disabled placeholder="Loading..."></textarea>

        <label for="landmark">Landmark</label>
        <textarea id="landmark" rows="2" disabled placeholder="Loading..."></textarea>

        <label for="pin_code">Pin Code</label>
        <input type="text" id="pin_code" disabled placeholder="Loading...">

        <div class="actions">
            <button type="button" class="edit-btn" onclick="enableEdit()">Edit</button>
            <button type="submit" class="save-btn">Save</button>
        </div>
    </form>
</div>

<script>
    const token = localStorage.getItem("userToken");

    function redirectToLogin() { localStorage.removeItem("userToken"); window.location.replace("user_login.html"); }

    if (!token) redirectToLogin();
    else {
        try {
            const payload = JSON.parse(atob(token.split('.')[1]));
            const now = Math.floor(Date.now() / 1000);
            if (now > payload.exp || (payload.role || '').toLowerCase() !== 'user') redirectToLogin();
        } catch { redirectToLogin(); }
    }

    function goBack() { window.location.href = "menu.html"; }

    function enableEdit(){
        document.querySelectorAll('#profileForm input, #profileForm textarea').forEach(el=>{
            if(el.id!=='name' && el.id!=='email') el.disabled=false;
        });
        document.querySelector('.edit-btn').style.display='none';
        document.querySelector('.save-btn').style.display='inline-block';
    }

    async function updateJSONLD(profile){
        const jsonLd = {
            "@context":"https://schema.org",
            "@type":"Person",
            "name": profile.name || "User Name",
            "url":"http://yourwebsite.com/user-profile",
            "description":"User profile page for Vyanjanam website. Users can view and update their contact and address details.",
            "image":"/image/myImage.jpg",
            "email": profile.email || "",
            "telephone": profile.contact || "",
            "address": {
                "@type":"PostalAddress",
                "streetAddress": profile.residential_address || "",
                "addressLocality": profile.permanent_address || "",
                "postalCode": profile.pin_code || "",
                "addressCountry": "IN"
            }
        };
        const scriptTag = document.getElementById("json-ld");
        scriptTag.textContent = JSON.stringify(jsonLd);
    }

    async function loadProfile(){
        const container = document.getElementById("profileContainer");
        const loading = document.getElementById("loading");
        try{
            const res = await fetch(" https://desi-delivery.onrender.com/user-profile", {
                headers: { "Authorization": "Bearer " + token, "Content-Type":"application/json" }
            });
            if(res.ok){
                const profile = await res.json();
                // Fill form fields
                ['name','email','contact','permanent','residential','landmark','pin_code'].forEach(id=>{
                    const key = id==='permanent' ? 'permanent_address' : id==='residential' ? 'residential_address' : id;
                    document.getElementById(id).value = profile[key] || "";
                });
                // Update JSON-LD dynamically
                updateJSONLD(profile);
                loading.style.display="none";
                container.style.display="block";
            } else { window.location.replace("user_login.html"); }
        } catch(err){ console.error(err); window.location.replace("user_login.html"); }
    }

    document.getElementById("profileForm").addEventListener("submit", async e=>{
        e.preventDefault();
        const data = {
            name: document.getElementById('name').value,
            email: document.getElementById('email').value,
            contact: document.getElementById('contact').value,
            permanent_address: document.getElementById('permanent').value,
            residential_address: document.getElementById('residential').value,
            landmark: document.getElementById('landmark').value,
            pin_code: document.getElementById('pin_code').value
        };
        try{
            const res = await fetch("http://127.0.0.1:5006/user-update-profile",{
                method:"PUT",
                headers: { "Authorization": "Bearer "+token, "Content-Type":"application/json" },
                body: JSON.stringify(data)
            });
            if(res.ok){
                const updated = await res.json();
                updateJSONLD(updated);
                document.querySelectorAll('#profileForm input, #profileForm textarea').forEach(el=>{
                    if(el.id!=='name' && el.id!=='email') el.disabled=true;
                });
                document.querySelector('.save-btn').style.display='none';
                document.querySelector('.edit-btn').style.display='inline-block';
                alert("Profile updated!");
            } else alert("Error updating profile");
        } catch(err){ console.error(err); alert("Something went wrong"); }
    });

    loadProfile();
</script>
</body>
</html>
